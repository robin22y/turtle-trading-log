<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Turtle Trading Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase access
        let app, db, auth, userId;

        // Custom function to show a modal with a callback for actions
        function showModal(title, message, callback = null) {
            const modal = document.getElementById('message-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');

            const onModalClose = () => {
                modal.classList.add('hidden');
                if (callback) {
                    callback();
                }
                modalCloseBtn.removeEventListener('click', onModalClose);
            };

            modalCloseBtn.addEventListener('click', onModalClose);
        }

        // Initialize Firebase and Auth
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate user
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showModal("Error", "Failed to connect to the database. Please try again later.");
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }

        // Render the trade table
        function renderTable(trades) {
            const tradeLogBody = document.getElementById('trade-log-body');
            const noTradesRow = document.getElementById('no-trades-row');
            tradeLogBody.innerHTML = '';
            if (trades.length === 0) {
                tradeLogBody.appendChild(noTradesRow);
                return;
            }

            trades.forEach(trade => {
                const newRow = document.createElement('tr');
                newRow.classList.add('hover:bg-gray-50');

                // Calculate the next buy price for pyramiding
                const nextBuyPrice = (trade.entryPrice + 0.5 * trade.atr).toFixed(2);
                
                newRow.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${trade.date}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${trade.ticker.toUpperCase()}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">$${trade.entryPrice.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-red-600">$${trade.stopLossPrice.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">${trade.positionSize} shares</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">$${trade.dollarsAtRisk.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">$${nextBuyPrice}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-2 edit-btn" data-id="${trade.id}">Edit</button>
                        <button class="text-red-600 hover:text-red-900 delete-btn" data-id="${trade.id}">Delete</button>
                    </td>
                `;
                tradeLogBody.appendChild(newRow);
            });
        }

        // Add or Update Trade
        async function saveTrade(tradeData, tradeId = null) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userTradesCollection = collection(db, `artifacts/${appId}/users/${userId}/trades`);

            try {
                if (tradeId) {
                    await setDoc(doc(userTradesCollection, tradeId), tradeData);
                } else {
                    await addDoc(userTradesCollection, tradeData);
                }
            } catch (error) {
                console.error("Error saving trade: ", error);
                showModal("Error", "Could not save trade. Please check your connection.");
            }
        }

        // Delete Trade
        async function deleteTrade(tradeId) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userTradesCollection = collection(db, `artifacts/${appId}/users/${userId}/trades`);

            try {
                await deleteDoc(doc(userTradesCollection, tradeId));
            } catch (error) {
                console.error("Error deleting trade: ", error);
                showModal("Error", "Could not delete trade. Please try again.");
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const tradeForm = document.getElementById('trade-form');
            const submitBtn = document.getElementById('submit-btn');

            let editingId = null;

            await initializeFirebase();

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const userTradesCollection = collection(db, `artifacts/${appId}/users/${userId}/trades`);
                    
                    onSnapshot(userTradesCollection, (snapshot) => {
                        const trades = [];
                        snapshot.forEach(doc => {
                            trades.push({ id: doc.id, ...doc.data() });
                        });
                        // Sort the trades by date in descending order for display
                        trades.sort((a, b) => new Date(b.date) - new Date(a.date));
                        renderTable(trades);
                    });
                } else {
                    showModal("Authentication Error", "Could not authenticate. Please refresh the page.");
                }
            });

            tradeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const ticker = document.getElementById('ticker').value;
                const strategy = document.getElementById('strategy').value;
                const equity = parseFloat(document.getElementById('equity').value);
                const atr = parseFloat(document.getElementById('atr').value);
                const riskPercent = parseFloat(document.getElementById('risk').value);
                const entryPrice = parseFloat(document.getElementById('entry-price').value);

                if (!ticker || isNaN(equity) || isNaN(atr) || isNaN(riskPercent) || isNaN(entryPrice)) {
                    showModal("Input Error", "Please fill in all fields with valid numbers.");
                    return;
                }

                const dollarsAtRisk = equity * (riskPercent / 100);
                const stopLossPrice = entryPrice - (2 * atr);
                const positionSize = Math.floor(dollarsAtRisk / (2 * atr));
                
                if (positionSize <= 0) {
                     showModal("Calculation Error", "Calculated position size is zero or less. Please check your inputs.");
                     return;
                }

                const tradeData = {
                    date: new Date().toISOString().slice(0, 10),
                    ticker,
                    strategy,
                    equity,
                    atr,
                    riskPercent,
                    entryPrice,
                    dollarsAtRisk,
                    stopLossPrice,
                    positionSize
                };

                await saveTrade(tradeData, editingId);
                tradeForm.reset();
                editingId = null;
                submitBtn.textContent = 'Calculate & Add Trade';
            });

            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('edit-btn')) {
                    const tradeId = e.target.dataset.id;
                    const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/trades`, tradeId);
                    getDoc(docRef).then(docSnap => {
                        if (docSnap.exists()) {
                            const trade = docSnap.data();
                            document.getElementById('ticker').value = trade.ticker;
                            document.getElementById('strategy').value = trade.strategy;
                            document.getElementById('equity').value = trade.equity;
                            document.getElementById('atr').value = trade.atr;
                            document.getElementById('risk').value = trade.riskPercent;
                            document.getElementById('entry-price').value = trade.entryPrice;
                            editingId = docSnap.id;
                            submitBtn.textContent = 'Update Trade';
                        }
                    }).catch(error => {
                        console.error("Error fetching document for edit:", error);
                        showModal("Error", "Could not load trade for editing.");
                    });
                } else if (e.target.classList.contains('delete-btn')) {
                    const tradeId = e.target.dataset.id;
                    showModal("Confirm Deletion", "Are you sure you want to delete this trade?", () => {
                        deleteTrade(tradeId);
                    });
                }
            });
        });
    </script>
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A single-page dashboard with a clear, two-part structure: a data input form at the top and a dynamic, real-time trade log table at the bottom. This design facilitates a logical workflow for the user to add, edit, and view their trade data. This structure was chosen for its intuitiveness and efficiency in managing personal data in a multi-user, cloud-synced environment. User actions on the form or table trigger real-time updates via Firebase, providing immediate feedback and a seamless experience across devices. -->
    <!-- Visualization & Content Choices: Report Info: User-entered trade parameters and a history of trades. Goal: To create a secure, persistent, and multi-user log of trades with automated calculations. Viz/Presentation Method: An interactive HTML form for input and a dynamic HTML table for displaying the log. This is the most effective method for data entry and display. Interaction: The app now supports creation, reading, updating, and deletion (CRUD) of entries through form submission and dedicated action buttons. The data is now stored in a Firestore database for persistence and multi-user functionality. A loading indicator and a message modal are added for a better user experience. Library/Method: Vanilla JavaScript and Firebase SDKs for real-time cloud data management. Tailwind CSS for styling and responsiveness. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF7;
            color: #383838;
        }
        .card {
            background-color: #FFFFFF;
            border: 1px solid #EAEAEA;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .btn-primary {
            background-color: #4A90E2;
            color: #FFFFFF;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #357ABD;
        }
        .table-header {
            background-color: #F7F7F7;
        }
        .form-input {
            border: 1px solid #D1D5DB;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4A90E2;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-[#383838]">Interactive Turtle Trading Log</h1>
            <p class="text-md text-gray-500 mt-2">Enter your trade details to automatically calculate position size and stop-loss based on Turtle rules.</p>
        </header>

        <main id="app-content" class="hidden">
            <div class="card rounded-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold mb-6">Add New Trade</h2>
                <div id="user-id-display" class="text-sm text-gray-500 mb-4"></div>
                <form id="trade-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="ticker" class="block text-sm font-medium text-gray-700 mb-1">Ticker</label>
                        <input type="text" id="ticker" placeholder="e.g., AAPL" class="form-input w-full rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="strategy" class="block text-sm font-medium text-gray-700 mb-1">Strategy</label>
                        <select id="strategy" class="form-input w-full rounded-md p-2 bg-white">
                            <option value="20-day">20-Day (Short-term)</option>
                            <option value="55-day">55-Day (Long-term)</option>
                        </select>
                    </div>
                    <div>
                        <label for="equity" class="block text-sm font-medium text-gray-700 mb-1">Account Equity ($)</label>
                        <input type="number" id="equity" placeholder="10000" class="form-input w-full rounded-md p-2" required step="0.01">
                    </div>
                    <div>
                        <label for="atr" class="block text-sm font-medium text-gray-700 mb-1">ATR (N)</label>
                        <input type="number" id="atr" placeholder="0.25" class="form-input w-full rounded-md p-2" required step="0.0001">
                    </div>
                    <div>
                        <label for="risk" class="block text-sm font-medium text-gray-700 mb-1">Risk %</label>
                        <input type="number" id="risk" value="1" class="form-input w-full rounded-md p-2" required step="0.1">
                    </div>
                    <div>
                        <label for="entry-price" class="block text-sm font-medium text-gray-700 mb-1">Entry Price ($)</label>
                        <input type="number" id="entry-price" placeholder="150.50" class="form-input w-full rounded-md p-2" required step="0.01">
                    </div>
                    <div class="md:col-span-2 lg:col-span-3 text-center mt-4">
                        <button type="submit" id="submit-btn" class="btn-primary font-semibold py-2 px-8 rounded-lg shadow-md">
                            Calculate & Add Trade
                        </button>
                    </div>
                </form>
            </div>

            <div class="card rounded-lg p-6">
                 <h2 class="text-2xl font-semibold mb-4">Trade Log</h2>
                 <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticker</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entry Price</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stop Loss</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position Size</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk ($)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Buy Price</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trade-log-body" class="bg-white divide-y divide-gray-200">
                            <tr id="no-trades-row">
                                <td colspan="8" class="px-4 py-4 text-center text-gray-500">No trades logged yet.</td>
                            </tr>
                        </tbody>
                    </table>
                 </div>
            </div>
        </main>

        <div id="loading-indicator" class="flex flex-col items-center justify-center min-h-screen">
            <div class="loading-spinner"></div>
            <p class="mt-4 text-gray-500">Connecting to database...</p>
        </div>

        <div id="message-modal" class="fixed inset-0 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm text-center">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-2"></h3>
                <p id="modal-message" class="text-sm text-gray-600 mb-4"></p>
                <button id="modal-close-btn" class="btn-primary py-2 px-4 rounded-lg">OK</button>
            </div>
        </div>

    </div>
</body>
</html>
